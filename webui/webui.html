<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>IPList 管理后台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #e0e7ef 0%, #f8fafc 100%);
      font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
    }
    .navbar {
      background: #2563eb;
      color: #fff;
      padding: 0.7rem 2rem;
      box-shadow: 0 2px 12px rgba(37,99,235,0.08);
      margin-bottom: 32px;
    }
    .navbar-brand {
      font-size: 1.6rem;
      font-weight: bold;
      color: #fff;
      letter-spacing: 1px;
    }
    .nav-link {
      color: #fff;
      font-size: 1.1rem;
      margin-right: 18px;
      transition: color 0.2s;
    }
    .nav-link.active, .nav-link:hover {
      color: #ffe066;
      text-decoration: underline;
    }
    .logout-btn {
      background: #f87171;
      border: none;
      border-radius: 6px;
      padding: 7px 18px;
      font-size: 15px;
      color: #fff;
      margin-left: 18px;
      transition: background 0.2s;
    }
    .logout-btn:hover { background: #dc2626; }
    .container {
      max-width: 1100px;
      margin: 0 auto 40px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.10);
      padding: 36px 32px 32px 32px;
    }
    .tab-content > .tab-pane { display: none; }
    .tab-content > .active { display: block; }
    .nav-tabs .nav-link.active {
      background: #2563eb;
      color: #fff;
      border-radius: 8px 8px 0 0;
    }
    .nav-tabs .nav-link {
      color: #2563eb;
      font-weight: 500;
      border: none;
      background: #f1f5f9;
      margin-right: 4px;
      border-radius: 8px 8px 0 0;
    }
    .section {
      margin-bottom: 36px;
      padding-bottom: 18px;
      border-bottom: 1.5px solid #e5e7eb;
    }
    .section:last-child { border-bottom: none; }
    .stat {
      display: inline-flex;
      align-items: center;
      margin-right: 32px;
      font-size: 17px;
      color: #2563eb;
      background: #f1f5f9;
      border-radius: 8px;
      padding: 8px 18px;
      margin-bottom: 10px;
    }
    .stat strong { font-size: 22px; color: #1e293b; margin-left: 6px; }
    .stat i { font-size: 1.5rem; margin-right: 8px; color: #60a5fa; }
    .table {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      margin-bottom: 10px;
    }
    .table th, .table td { vertical-align: middle; }
    .table th { background: #f1f5f9; color: #333; font-weight: 600; }
    .table-striped > tbody > tr:nth-of-type(odd) { background-color: #f8fafc; }
    .ip-table th, .ip-table td { text-align: center; }
    .ip-table th { background: #f1f5f9; }
    .ip-table { border-radius: 8px; overflow: hidden; }
    .badge-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      color: #fff;
    }
    .badge-active { background: #22c55e; }
    .badge-paused { background: #64748b; }
    .btn {
      border-radius: 6px;
      font-size: 15px;
      padding: 6px 18px;
      margin: 4px 4px 4px 0;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(37,99,235,0.08);
    }
    .btn-primary { background: #2563eb; border: none; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-outline-secondary { border: 1.5px solid #cbd5e1; color: #2563eb; background: #f8fafc; }
    .btn-outline-secondary:hover { background: #e0e7ef; }
    .form-row { display: flex; flex-wrap: wrap; gap: 18px; align-items: center; }
    .form-row label { flex: 1 1 180px; margin-bottom: 0; }
    .form-row input, .form-row select { flex: 2 1 320px; margin-bottom: 0; }
    .form-row .form-check { flex: 0 0 auto; margin-left: 18px; }
    .form-check-label { margin-left: 4px; font-weight: 400; }
    .key-card {
      background: #f1f5f9;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      padding: 16px 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .key-info { font-weight: bold; color: #2563eb; }
    .key-balance input { width: 80px; }
    .key-date { color: #64748b; font-size: 14px; }
    .key-actions button { margin-left: 8px; }
    
    /* Toast 消息样式 */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(37, 99, 235, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999;
      transition: opacity 0.3s;
    }
    
    .toast-error {
      background: rgba(239, 68, 68, 0.9);
    }
    
    /* 移动端响应式优化 */
    .mobile-menu-button {
      display: none;
      font-size: 1.5rem;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    @media (max-width: 768px) {
      /* 顶部导航栏 */
      .navbar {
        padding: 0.7rem 1rem;
      }
      
      .navbar-container {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .navbar-links {
        display: none;
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
        margin-top: 10px;
      }
      
      .navbar-links.show {
        display: flex;
      }
      
      .mobile-menu-button {
        display: block;
      }
      
      .navbar-brand {
        font-size: 1.4rem;
      }
      
      .nav-link {
        font-size: 0.9rem;
        margin-right: 0;
        margin-bottom: 8px;
        padding: 5px 0;
        width: 100%;
      }
      
      .logout-btn {
        margin-left: 0;
        margin-top: 8px;
        width: 100%;
        text-align: center;
      }
      
      /* 容器样式 */
      .container {
        padding: 20px 15px;
        border-radius: 12px;
        margin-top: 15px;
        margin-bottom: 15px;
      }
      
      .section {
        margin-bottom: 25px;
        padding-bottom: 15px;
      }
      
      /* 状态卡片 */
      .stat {
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
        justify-content: center;
      }
      
      /* 表单元素优化 */
      .row {
        margin-right: -8px;
        margin-left: -8px;
      }
      
      .col-md-4, .col-md-6, .col-md-2, .col-md-3 {
        padding-right: 8px;
        padding-left: 8px;
      }
      
      .form-label {
        font-size: 0.9rem;
        margin-bottom: 4px;
      }
      
      .form-control {
        padding: 8px;
        font-size: 0.9rem;
      }
      
      .btn {
        padding: 8px 15px;
        font-size: 0.9rem;
        margin-bottom: 8px;
      }
      
      /* 表格响应式 */
      .table-responsive-mobile {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .table th, .table td {
        white-space: nowrap;
        padding: 8px;
        font-size: 0.85rem;
      }
      
      .table-actions {
        display: flex;
        flex-direction: column;
      }
      
      .table-actions .btn {
        margin-bottom: 5px;
        width: 100%;
      }
      
      /* 重要列保持显示，次要列可隐藏 */
      .mobile-hide {
        display: none;
      }
      
      /* API Key卡片 */
      .key-card {
        flex-direction: column;
        align-items: flex-start;
        padding: 15px;
      }
      
      .key-info {
        margin-bottom: 10px;
        word-break: break-all;
        width: 100%;
      }
      
      .key-balance {
        margin-bottom: 10px;
        width: 100%;
      }
      
      .key-balance input {
        width: 100%;
        max-width: 120px;
      }
      
      .key-date {
        margin-bottom: 10px;
        width: 100%;
      }
      
      .key-actions {
        width: 100%;
        display: flex;
        justify-content: flex-end;
      }
      
      /* Toast位置优化 */
      .toast {
        top: auto;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        text-align: center;
      }
      
      /* Tab导航优化 */
      .nav-tabs {
        display: flex;
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 5px;
      }
      
      .nav-tabs .nav-link {
        font-size: 0.9rem;
        padding: 6px 12px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <span class="navbar-brand">IPList 管理后台</span>
      <button class="mobile-menu-button" onclick="toggleMobileMenu()">
        <i class="bi bi-list"></i>
      </button>
    </div>
    <div class="navbar-links">
      <a class="nav-link active" href="#" onclick="showTab('tab-tasks')">任务管理</a>
      <a class="nav-link" href="#" onclick="showTab('tab-settings')">系统设置</a>
      <a class="nav-link" href="#" onclick="showTab('tab-logs')">日志系统</a>
      <a class="nav-link" href="#" onclick="showTab('tab-keys')">API Key 管理</a>
      <button class="logout-btn" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 退出登录</button>
    </div>
  </nav>
  <div class="container">
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><a class="nav-link active" id="tab-tasks-btn" href="#" onclick="showTab('tab-tasks')">任务管理</a></li>
      <li class="nav-item"><a class="nav-link" id="tab-settings-btn" href="#" onclick="showTab('tab-settings')">系统设置</a></li>
      <li class="nav-item"><a class="nav-link" id="tab-logs-btn" href="#" onclick="showTab('tab-logs')">日志系统</a></li>
      <li class="nav-item"><a class="nav-link" id="tab-keys-btn" href="#" onclick="showTab('tab-keys')">API Key 管理</a></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane active" id="tab-tasks">
        <div class="section card" id="sysinfo">
          <h2>系统信息</h2>
          <div id="sysstat">
            <span class="stat"><i class="bi bi-list-task"></i>任务总数：<strong id="stat-task">-</strong></span>
            <span class="stat"><i class="bi bi-lightning-charge"></i>活跃任务：<strong id="stat-active">-</strong></span>
            <span class="stat"><i class="bi bi-database"></i>数据库类型：<strong id="stat-db">-</strong></span>
          </div>
        </div>
        <div class="section card">
          <h2 class="mb-3">任务管理</h2>
          <div class="mb-3 d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary" onclick="loadTaskList()">刷新任务列表</button>
            <button id="batchStopBtn" class="btn btn-outline-secondary" onclick="batchStopTask()" style="display:none;">批量暂停</button>
          </div>
          <div class="table-responsive-mobile">
            <table id="tasktable" class="table table-striped table-hover align-middle" style="display:none">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllTasks" /></th>
                  <th>任务ID</th>
                  <th>状态</th>
                  <th class="mobile-hide">创建时间</th>
                  <th>IP数</th>
                  <th class="mobile-hide">图片</th>
                  <th class="mobile-hide">有效期</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="row g-3 mb-2">
            <div class="col-md-4">
              <label class="form-label">自定义图片URL</label>
              <input id="customImgUrl" type="text" class="form-control" placeholder="留空用全局" />
            </div>
            <div class="col-md-2">
              <label class="form-label" for="customTime">有效期(分钟,0为永久)</label>
              <input id="customTime" type="number" min="0" max="10080" value="10" class="form-control" placeholder="10" title="有效期(分钟,0为永久)" />
            </div>
            <div class="col-md-4">
              <label class="form-label">链接URL</label>
              <input id="customUrl" type="text" class="form-control" placeholder="可选" />
            </div>
          </div>
          <div class="row g-3 mb-2">
            <div class="col-md-3">
              <label class="form-label">自定义标题</label>
              <input id="customText" type="text" class="form-control" placeholder="可选" />
            </div>
            <div class="col-md-3">
              <label class="form-label">自定义内容</label>
              <input id="customText1" type="text" class="form-control" placeholder="可选" />
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <div class="form-check">
                <input id="customPb" type="checkbox" class="form-check-input" />
                <label class="form-check-label" for="customPb">特殊格式(data=pb)</label>
              </div>
            </div>
          </div>
          <div class="mb-2">
            <button class="btn btn-primary" onclick="startTask()">开启任务</button>
            <button class="btn btn-outline-secondary" onclick="stopTask()">暂停任务</button>
          </div>
          <div class="mb-2">当前任务ID: <span id="taskid" class="fw-bold text-primary">(无)</span>
            <span id="recordlinkbox" style="display:none;margin-left:10px;">
              <a id="recordlink" href="#" target="_blank" class="btn btn-sm btn-outline-primary">记录链接</a>
            </span>
          </div>
          <div id="taskimgbox" class="mb-2"></div>
          <button class="btn btn-outline-secondary mb-2" onclick="getIpList()">获取IP列表</button>
          <div id="iplist"></div>
          <div id="taskipbox" style="display:none;margin-top:16px;"></div>
          <div id="taskCreateResult"></div>
        </div>
      </div>
      <div class="tab-pane" id="tab-settings">
        <div class="section card">
          <h2 class="mb-3">系统设置</h2>
          <form id="settings">
            <div class="row g-3 mb-2">
              <div class="col-md-4">
                <label for="imgurl" class="form-label">图片URL</label>
                <input id="imgurl" type="text" class="form-control" placeholder="图片URL" />
              </div>
              <div class="col-md-4">
                <label for="imgdir" class="form-label">图片库路径</label>
                <input id="imgdir" type="text" class="form-control" placeholder="如 ./images" />
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <div class="form-check">
                  <input id="localfirst" type="checkbox" class="form-check-input" />
                  <label class="form-check-label" for="localfirst">本地图片优先</label>
                </div>
              </div>
            </div>
            <div class="row g-3 mb-2">
              <div class="col-md-6">
                <label for="ipapi" class="form-label">IP归属API</label>
                <input id="ipapi" type="text" class="form-control" placeholder="如 https://ipinfo.io/" />
              </div>
              <div class="col-md-6">
                <label for="token2" class="form-label">管理员Token(修改)</label>
                <input id="token2" type="password" class="form-control" placeholder="新管理员Token" />
              </div>
            </div>
            <div class="mb-2">
              <button type="button" class="btn btn-primary" onclick="saveSettings()">保存设置</button>
            </div>
          </form>
        </div>
      </div>
      <div class="tab-pane" id="tab-logs">
        <div class="section card">
          <h2 class="mb-3">日志系统</h2>
          <div class="d-flex gap-2 mb-2 align-items-center flex-wrap">
            <button id="refreshLogBtn" class="btn btn-outline-primary" onclick="loadLog()">刷新日志</button>
            <button id="clearLogBtn" class="btn btn-outline-danger" onclick="clearLog()">清空日志</button>
            <span id="logLoadingTip" class="ms-3 text-secondary" style="display:none;"><span class="spinner-border spinner-border-sm me-1"></span>日志加载中…</span>
            <span id="logAutoRefreshTip" class="ms-3 text-secondary" style="display:none;">自动刷新中…</span>
          </div>
          <div class="bg-dark text-light rounded p-3 mb-2" id="log" style="min-height:180px;max-height:320px;overflow:auto;font-family:monospace;font-size:14px;"></div>
          <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="prevLogPage()">上一页</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="nextLogPage()">下一页</button>
          </div>
        </div>
      </div>
      <div class="tab-pane" id="tab-keys">
        <div class="section card">
          <h2 class="mb-3">API Key 管理</h2>
          <div class="d-flex gap-2 mb-2 align-items-center flex-wrap">
            <button id="refreshKeyBtn" class="btn btn-outline-primary" onclick="loadKeyList()">刷新Key列表</button>
            <span id="keyLoadingTip" class="ms-3 text-secondary" style="display:none;"><span class="spinner-border spinner-border-sm me-1"></span>Key列表加载中…</span>
            <span id="keyAutoRefreshTip" class="ms-3 text-secondary" style="display:none;">自动刷新中…</span>
          </div>
          <div id="keycardlist" class="mb-3"></div>
          <form id="addkeyform" class="row g-2 align-items-center">
            <div class="col-auto">
              <input id="newkey" type="text" class="form-control" placeholder="新Key（可随机）" style="width:180px;" />
            </div>
            <div class="col-auto">
              <input id="newbalance" type="number" class="form-control" placeholder="初始余额" style="width:100px;" />
            </div>
            <div class="col-auto">
              <button type="button" class="btn btn-primary" onclick="addKey()">新增Key</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script>
    let taskId = '';
    let logStart = 0;
    const logLimit = 200;
    let autoRefreshTimer = null;
    let isTableHover = false;
    
    // 移动端菜单切换
    function toggleMobileMenu() {
      const navbarLinks = document.querySelector('.navbar-links');
      navbarLinks.classList.toggle('show');
    }
    
    // 检测屏幕大小设置合适布局
    function detectScreenSize() {
      const isMobile = window.innerWidth < 768;
      document.body.classList.toggle('mobile-view', isMobile);
      
      // 调整表格显示
      const mobileHideColumns = document.querySelectorAll('.mobile-hide');
      if (mobileHideColumns) {
        mobileHideColumns.forEach(col => {
          col.style.display = isMobile ? 'none' : '';
        });
      }
    }
    
    // 自动刷新任务列表
    function startAutoRefreshTaskList() {
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      autoRefreshTimer = setInterval(() => {
        if (!isTableHover) loadTaskList();
      }, 30000);
    }
    
    function stopAutoRefreshTaskList() {
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    }
    
    // 绑定表格悬停事件，悬停时暂停自动刷新
    document.addEventListener('DOMContentLoaded', () => {
      const table = document.getElementById('tasktable');
      if (table) {
        table.addEventListener('mouseenter', () => { isTableHover = true; });
        table.addEventListener('mouseleave', () => { isTableHover = false; });
      }
      startAutoRefreshTaskList();
      
      // 监听屏幕尺寸变化
      window.addEventListener('resize', detectScreenSize);
      detectScreenSize();
    });
    
    // 统一API请求自动拼接token参数，前端不再做任何token检测
    function getToken() {
      const m = document.cookie.match(/(?:^|;)\s*webui_token=([^;]+)/);
      return m ? m[1] : '';
    }
    
    function fetchWithToken(url, options = {}) {
      const token = getToken();
      let realUrl = url;
      if (token) {
        const sep = url.includes('?') ? '&' : '?';
        realUrl = `${url}${sep}token=${encodeURIComponent(token)}`;
      }
      return fetch(realUrl, { ...options, credentials: 'include' });
    }
    
    function loadTaskList() {
      fetch('/api/list', { credentials: 'include' })
        .then(r=>r.json()).then(data=>{
          const table = document.getElementById('tasktable');
          const tbody = table.querySelector('tbody');
          tbody.innerHTML = '';
          let activeCount = 0;
          let hasTasks = data.tasks && data.tasks.length;
          const isMobile = window.innerWidth < 768;
          
          if(hasTasks) {
            data.tasks.forEach(t=>{
              const tr = document.createElement('tr');
              
              if (isMobile) {
                // 移动端简化版行
                tr.innerHTML = `
                  <td><input type='checkbox' class='task-checkbox' data-id='${t.id}' /></td>
                  <td>${t.id}</td>
                  <td><span class='badge badge-status ${t.status==="活跃"?'badge-active':'badge-paused'}'>${t.status}</span></td>
                  <td class="text-center"><span style='color:#2563eb;font-weight:bold;'>${t.ipCount||0}</span></td>
                  <td>
                    <div class="table-actions">
                      <button class='btn btn-sm btn-primary mb-1' onclick='showTaskIp("${t.id}")'><i class='bi bi-eye'></i> 查看IP</button>
                      <a href='/api/page/${t.id}' target='_blank' class='btn btn-sm btn-outline-primary'><i class='bi bi-link-45deg'></i> 记录链接</a>
                      <button class='btn btn-sm btn-outline-secondary' onclick='copyTaskLink("${t.id}")'><i class='bi bi-clipboard'></i> 复制</button>
                    </div>
                  </td>
                `;
              } else {
                // 桌面版完整行
                tr.innerHTML = `
                  <td><input type='checkbox' class='task-checkbox' data-id='${t.id}' /></td>
                  <td>${t.id}</td>
                  <td><span class='badge badge-status ${t.status==="活跃"?'badge-active':'badge-paused'}'>${t.status}</span></td>
                  <td class="mobile-hide">${t.created_at}</td>
                  <td class='text-center'><span style='color:#2563eb;font-weight:bold;'>${t.ipCount||0}</span></td>
                  <td class="mobile-hide">${t.imgurl ? `<img src='${t.imgurl}' style='max-width:60px;max-height:40px;cursor:pointer;border-radius:6px;box-shadow:0 1px 4px #cbd5e1;' onclick='previewImg(\"${t.imgurl}\")' title='点击预览'/>` : '-'}</td>
                  <td class="mobile-hide">${t.time===0?'永久':t.time+'分钟'}</td>
                  <td>
                    <button class='btn btn-sm btn-primary' onclick='showTaskIp("${t.id}")'><i class='bi bi-eye'></i> 查看IP</button>
                    <a href='/api/page/${t.id}' target='_blank' class='btn btn-sm btn-outline-primary'><i class='bi bi-link-45deg'></i> 记录链接</a>
                    <button class='btn btn-sm btn-outline-secondary ms-1' onclick='copyTaskLink("${t.id}")'><i class='bi bi-clipboard'></i> 复制</button>
                  </td>
                `;
              }
              
              tr.onclick = (e)=>{
                if(e.target.tagName==='BUTTON' || e.target.type==='checkbox') return;
                taskId = t.id;
                document.getElementById('taskid').innerText = taskId;
                if(t.imgurl){
                  document.getElementById('taskimgbox').innerHTML = `<img src='${t.imgurl}' style='max-width:220px;max-height:120px;cursor:pointer;' onclick='previewImg("${t.imgurl}")' title='点击放大预览'/>`;
                }else{
                  document.getElementById('taskimgbox').innerHTML = '';
                }
              };
              
              if(t.status==='活跃') activeCount++;
              tbody.appendChild(tr);
            });
            table.style.display = '';
            document.getElementById('batchStopBtn').style.display = '';
          } else {
            table.style.display = 'none';
            document.getElementById('batchStopBtn').style.display = 'none';
          }
          
          document.getElementById('stat-task').innerText = hasTasks ? data.tasks.length : 0;
          document.getElementById('stat-active').innerText = activeCount;
          
          // 绑定全选事件
          const selectAll = document.getElementById('selectAllTasks');
          if(selectAll) {
            selectAll.checked = false;
            selectAll.onclick = function() {
              document.querySelectorAll('.task-checkbox').forEach(cb=>{ cb.checked = selectAll.checked; });
            };
          }
        });
    }
    
    async function startTask() {
      // 新建任务时带上自定义图片和有效期参数
      const imgurl = document.getElementById('customImgUrl').value.trim();
      const time = parseInt(document.getElementById('customTime').value) || 10;
      const urlVal = document.getElementById('customUrl').value.trim();
      const text = document.getElementById('customText').value.trim();
      const text1 = document.getElementById('customText1').value.trim();
      const pb = document.getElementById('customPb').checked;
      let url = '/api/server';
      const params = [];
      if(imgurl) params.push('imgurl='+encodeURIComponent(imgurl));
      if(time!==10) params.push('time='+time);
      if(urlVal) params.push('url='+encodeURIComponent(urlVal));
      if(text) params.push('text='+encodeURIComponent(text));
      if(text1) params.push('text1='+encodeURIComponent(text1));
      if(pb) params.push('data=pb');
      if(params.length) url += '?' + params.join('&');
      const res = await fetchWithToken(url);
      if (!res) return;
      if (res.status === 401 || res.status === 403) {
        showToast('登录已失效，请重新登录', 'error');
        window.location.href = '/login';
        return;
      }
      if (!res.ok) {
        showToast('创建任务失败，状态码：' + res.status, 'error');
        return;
      }
      const data = await res.json();
      // 页面内展示结果
      let html = '';
      if(data.taskId && data.recordUrl){
        taskId = data.taskId;
        document.getElementById('taskid').innerText = taskId;
        if(data.recordUrl){
          const link = document.getElementById('recordlink');
          link.href = data.recordUrl;
          link.innerText = '记录链接';
          document.getElementById('recordlinkbox').style.display = '';
        }
        html = `<div class='alert alert-success d-flex align-items-center' style='margin-top:12px;'>
          <div>
            <b>任务已开启！</b>

            <span>任务ID：</span><span class='fw-bold text-primary' id='copyTaskId'>${data.taskId}</span>
            <button class='btn btn-sm btn-outline-secondary ms-2' onclick='copyText("${data.taskId}")'>复制ID</button>

            <span>记录链接：</span><a href='${data.recordUrl}' target='_blank' id='copyTaskUrl'>${data.recordUrl}</a>
            <button class='btn btn-sm btn-outline-secondary ms-2' onclick='copyText("${data.recordUrl}")'>复制链接</button>
          </div>
        </div>`;
        loadTaskList();
      }else if(data['1'] && data['1']['12'] && data['1']['12']['14']){
        const recordUrl = data['1']['12']['14']['3'];
        const url = data['1']['1'];
        html = `<div class='alert alert-success d-flex align-items-center' style='margin-top:12px;'>
          <div>
            <b>特殊格式任务创建成功！</b>

            <span>链接：</span><a href='${url}' target='_blank'>${url}</a>

            <span>记录地址：</span><a href='${recordUrl}' target='_blank' id='copyTaskUrl'>${recordUrl}</a>
            <button class='btn btn-sm btn-outline-secondary ms-2' onclick='copyText("${recordUrl}")'>复制链接</button>

            <span>完整返回：</span><pre style='font-size:13px;background:#f8fafc;border-radius:6px;padding:8px 12px;'>${JSON.stringify(data, null, 2)}</pre>
          </div>
        </div>`;
        loadTaskList();
      }else{
        html = `<div class='alert alert-danger' style='margin-top:12px;'>开启失败：${data.error||'未知错误'}</div>`;
      }
      document.getElementById('taskCreateResult').innerHTML = html;
    }
    
    async function stopTask() {
      if(!taskId) {
        showToast('无任务ID', 'error');
        return;
      }
      
      const res = await fetchWithToken(`/api/stop?id=${taskId}`);
      if (!res) return;
      if (res.status === 401 || res.status === 403) {
        showToast('登录已失效，请重新登录', 'error');
        window.location.href = '/login';
        return;
      }
      const data = await res.json();
      if(data.success){
        showToast('已暂停', 'success');
        loadTaskList();
      }else{
        showToast('暂停失败：' + (data.error||'未知错误'), 'error');
      }
    }
    
    async function getIpList() {
      if(!taskId) {
        showToast('无任务ID', 'error');
        return;
      }
      
      const res = await fetchWithToken(`/api/getip/${taskId}`);
      if (!res) return;
      if (res.status === 401 || res.status === 403) {
        showToast('登录已失效，请重新登录', 'error');
        window.location.href = '/login';
        return;
      }
      const data = await res.json();
      if(data.ips){
        let html = renderIpTable(data.ips);
        document.getElementById('iplist').innerHTML = html;
      }else{
        document.getElementById('iplist').innerText = '获取失败：' + (data.error||'未知错误');
      }
    }
    
    function renderIpTable(ips) {
      let html = `<div class="table-responsive-mobile"><table class="table table-bordered ip-table"><thead><tr><th>IP</th><th>归属地</th><th>时间</th></tr></thead><tbody>`;
      (ips || []).forEach(ipObj => {
        let location = '-';
        let org = '';
        if (Array.isArray(ipObj.apis) && ipObj.apis.length > 0) {
          const api = ipObj.apis[0];
          location = [api.country, api.region, api.city].filter(Boolean).join(' ');
          org = api.isp || api.org || '';
          if (org) location += ' ' + org;
          if (!location.trim()) location = '-';
        }
        html += `<tr><td>${ipObj.ip}</td><td>${location}</td><td>${ipObj.created_at || '-'}</td></tr>`;
      });
      html += '</tbody></table></div>';
      return html;
    }
    
    function loadSettings() {
      fetch('/api/webui/settings', { credentials: 'include' })
        .then(r=>{
          if(r.status===200) return r.json();
          throw new Error('无法获取设置，状态码：'+r.status);
        })
        .then(cfg=>{
          document.getElementById('imgurl').value = cfg.IMAGE_URL||'';
          document.getElementById('imgdir').value = cfg.IMAGE_DIR||'';
          document.getElementById('localfirst').checked = !!cfg.LOCAL_IMAGE_FIRST;
          document.getElementById('ipapi').value = cfg.IPINFO_API||'';
          document.getElementById('token2').value = '';
          document.getElementById('stat-db').innerText = cfg.DB_TYPE||'-';
        })
        .catch(e=>{
          showToast('加载设置失败：'+e.message, 'error');
        });
    }
    
    function saveSettings() {
      const body = {
        IMAGE_URL: document.getElementById('imgurl').value,
        IMAGE_DIR: document.getElementById('imgdir').value,
        LOCAL_IMAGE_FIRST: document.getElementById('localfirst').checked,
        IPINFO_API: document.getElementById('ipapi').value,
        ADMIN_TOKEN: document.getElementById('token2').value
      };
      fetch('/api/webui/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        credentials: 'include'
      }).then(r => r.json()).then(data => {
        if(data.success){
          showToast('设置已保存', 'success');
          loadSettings();
        }else{
          showToast('保存失败：'+(data.error||'未知错误'), 'error');
        }
      });
    }
    
    function logout() {
      fetch('/logout', { method: 'POST', credentials: 'include' }).then(()=>window.location.href='/login');
    }
    
    async function loadLog() {
      document.getElementById('logLoadingTip').style.display = '';
      try {
        const r = await fetch('/api/webui/logs', { credentials: 'include' });
        const data = await r.json();
        document.getElementById('log').innerText = data.logs||'';
      } finally {
        document.getElementById('logLoadingTip').style.display = 'none';
      }
    }
    
    function clearLog() {
      if(!confirm('确定要清空日志吗？')) return;
      fetch('/api/webui/logs/clear', { method: 'POST', credentials: 'include' })
        .then(r=>r.json()).then(data=>{
        if(data.success){
          showToast('日志已清空', 'success');
          logStart = 0;
          loadLog();
        }else{
          showToast('清空失败：'+(data.error||'未知错误'), 'error');
        }
      });
    }
    
    function prevLogPage() {
      logStart = Math.max(0, logStart - logLimit);
      loadLog();
    }
    
    function nextLogPage() {
      logStart += logLimit;
      loadLog();
    }
    
    function showTaskIp(tid) {
      fetchWithToken(`/api/getip/${tid}`)
        .then(r => {
          if (r.status === 401 || r.status === 403) {
            showToast('登录已失效，请重新登录', 'error');
            window.location.href = '/login';
            return;
          }
          return r.json();
        })
        .then(data => {
          if (!data) return;
          const box = document.getElementById('taskipbox');
          if(data.ips && data.ips.length) {
            let html = `<div><b>任务 <span style='color:#2563eb'>${tid}</span> IP记录：</b>
`;
            html += renderIpTable(data.ips);
            html += '</div>';
            box.innerHTML = html;
            box.style.display = '';
          } else {
            box.innerHTML = '<div style="color:#f87171">无记录或获取失败</div>';
            box.style.display = '';
          }
        });
    }
    
    function copyTaskLink(tid) {
      const url = location.protocol + '//' + location.host + '/api/page/' + tid;
      navigator.clipboard.writeText(url).then(()=>{
        showToast('链接已复制', 'success');
      });
    }
    
    function showToast(msg, type) {
      let toast = document.createElement('div');
      toast.className = 'toast' + (type==='error' ? ' toast-error' : '');
      toast.innerText = msg;
      document.body.appendChild(toast);
      setTimeout(()=>{ toast.style.opacity = 0; }, 1800);
      setTimeout(()=>{ toast.remove(); }, 2200);
    }
    
    function renderKeyCard(k) {
      const div = document.createElement('div');
      div.className = 'key-card';
      div.innerHTML = `
        <div class='key-info'>${k.api_key}</div>
        <div class='key-balance'>
          余额: <input type='number' value='${k.balance}' id='bal_${k.api_key}' />
        </div>
        <div class='key-date'>创建时间: ${new Date(k.created_at).toLocaleString()}</div>
        <div class='key-actions'>
          <button class='btn btn-sm btn-outline-danger' onclick='deleteKey("${k.api_key}")'>删除</button>
        </div>
      `;
      // 余额输入框事件
      const input = div.querySelector('input');
      input.addEventListener('keydown', function(e){
        if(e.key === 'Enter') saveKeyBalance(k.api_key, input.value);
      });
      input.addEventListener('blur', function(){
        saveKeyBalance(k.api_key, input.value);
      });
      return div;
    }
    
    async function loadKeyList() {
      document.getElementById('keyLoadingTip').style.display = '';
      try {
        const r = await fetch('/api/keys/list', { credentials: 'include' });
        const data = await r.json();
        const list = document.getElementById('keycardlist');
        list.innerHTML = '';
        if(data.keys && data.keys.length) {
          data.keys.forEach(k=>{
            list.appendChild(renderKeyCard(k));
          });
        }
      } finally {
        document.getElementById('keyLoadingTip').style.display = 'none';
      }
    }
    
    function saveKeyBalance(api_key, balance) {
      fetch('/api/keys/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ api_key, balance }),
        credentials: 'include'
      }).then(r => r.json()).then(data => {
        if(data.success) showToast('保存成功', 'success');
        else showToast('保存失败', 'error');
        loadKeyList();
      }).catch(()=>showToast('保存失败', 'error'));
    }
    
      function deleteKey(api_key) {
    if(!confirm('确定要删除此Key？')) return;
    fetch('/api/keys/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ api_key }),
      credentials: 'include'
    }).then(r => r.json()).then(data => {
      if(data.success){
        showToast('删除成功', 'success');
        loadKeyList();
      } else {
        showToast('删除失败', 'error');
      }
    });
  }

  function addKey() {
    const api_key = document.getElementById('newkey').value || Math.random().toString(36).slice(2, 12);
    const balance = parseInt(document.getElementById('newbalance').value) || 0;
    fetch('/api/keys/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ api_key, balance }),
      credentials: 'include'
    }).then(r => r.json()).then(data => {
      if(data.success){
        showToast('Key已添加', 'success');
        loadKeyList();
      } else {
        showToast('添加失败', 'error');
      }
    });
  }

  async function batchStopTask() {
    const checked = Array.from(document.querySelectorAll('.task-checkbox:checked'));
    if(checked.length === 0) {
      showToast('请先选择要暂停的任务', 'error');
      return;
    }
    
    if(!confirm('确定要暂停选中的'+checked.length+'个任务吗？')) return;
    
    let success = 0, fail = 0;
    await Promise.all(checked.map(async cb => {
      const tid = cb.getAttribute('data-id');
      try {
        const res = await fetchWithToken(`/api/stop?id=${tid}`);
        const data = await res.json();
        if(data.success) success++;
        else fail++;
      } catch(e) { fail++; }
    }));
    
    showToast(`批量暂停完成，成功：${success}，失败：${fail}`, 'success');
    loadTaskList();
  }

  // 检查是否管理员登录
  function isAdmin() {
    return document.cookie.includes('webui_token=');
  }
  
  function showAdminPanels() {
    if(isAdmin()) {
      const rateLimitPanel = document.getElementById('rate-limit-config-panel');
      const banIpPanel = document.getElementById('ban-ip-panel');
      
      if (rateLimitPanel) rateLimitPanel.style.display = '';
      if (banIpPanel) banIpPanel.style.display = '';
      
      loadRateLimitConfig();
      loadBanIpList();
    }
  }
  
  // ====== 限速参数设置 ======
  function loadRateLimitConfig() {
    fetch('/api/webui/rate-limit-config', { credentials: 'include' })
      .then(r=>r.json())
      .then(data=>{
        for(const k in data.config) {
          const input = document.querySelector(`[name=${k}]`);
          if(input) input.value = data.config[k];
        }
      });
  }
  
  // ====== 封禁IP管理 ======
  function loadBanIpList(){
    fetch('/api/webui/ban-ip-list', { credentials: 'include' })
      .then(r=>r.json())
      .then(data=>{
        const ul = document.getElementById('banIpUl');
        if(!ul) return;
        
        ul.innerHTML = '';
        if(!data.list.length) ul.innerHTML = '<li>当前无被封禁IP</li>';
        
        data.list.forEach(item=>{
          const li = document.createElement('li');
          li.textContent = `${item.ip} 封禁至 ${new Date(item.banUntil).toLocaleString()} `;
          
          const btn = document.createElement('button');
          btn.className = 'btn btn-sm btn-outline-secondary ms-2';
          btn.textContent = '解封';
          btn.onclick = ()=>{
            fetch('/api/webui/unban-ip', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ip: item.ip }),
              credentials: 'include'
            })
              .then(r => r.json())
              .then(resp => {
                showToast(resp.msg || '操作成功', 'success');
                loadBanIpList();
              });
          };
          
          li.appendChild(btn);
          ul.appendChild(li);
        });
      });
  }
  
  // 图片预览大图弹窗
  function previewImg(url) {
    const img = document.createElement('img');
    img.src = url;
    img.style.maxWidth = '90vw';
    img.style.maxHeight = '80vh';
    img.style.display = 'block';
    img.style.margin = '40px auto';
    
    const mask = document.createElement('div');
    mask.style.position = 'fixed';
    mask.style.left = 0;
    mask.style.top = 0;
    mask.style.width = '100vw';
    mask.style.height = '100vh';
    mask.style.background = 'rgba(0,0,0,0.85)';
    mask.style.zIndex = 9999;
    mask.style.display = 'flex';
    mask.style.alignItems = 'center';
    mask.style.justifyContent = 'center';
    
    const closeBtn = document.createElement('button');
    closeBtn.textContent = '×';
    closeBtn.style.position = 'absolute';
    closeBtn.style.top = '20px';
    closeBtn.style.right = '20px';
    closeBtn.style.background = 'none';
    closeBtn.style.border = 'none';
    closeBtn.style.color = 'white';
    closeBtn.style.fontSize = '30px';
    closeBtn.style.cursor = 'pointer';
    
    mask.appendChild(img);
    mask.appendChild(closeBtn);
    
    mask.onclick = (e) => {
      if (e.target !== img) document.body.removeChild(mask);
    };
    
    document.body.appendChild(mask);
  }
  
  // Tab切换逻辑
  function showTab(tabId) {
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    document.getElementById(tabId+'-btn').classList.add('active');
    
    // 在移动设备上切换标签时关闭菜单
    const navbarLinks = document.querySelector('.navbar-links');
    if (navbarLinks && navbarLinks.classList.contains('show')) {
      navbarLinks.classList.remove('show');
    }
  }
  
  // 一键复制
  function copyText(text) {
    navigator.clipboard.writeText(text).then(()=>{
      showToast('已复制', 'success');
    });
  }
  
  // 日志区块每10秒自动刷新，自动刷新时按钮禁用并有提示
  let logAutoRefreshTimer = null;
  
  function startLogAutoRefresh() {
    if (logAutoRefreshTimer) clearInterval(logAutoRefreshTimer);
    document.getElementById('logAutoRefreshTip').style.display = '';
    document.getElementById('refreshLogBtn').disabled = true;
    logAutoRefreshTimer = setInterval(loadLog, 10000);
  }
  
  function stopLogAutoRefresh() {
    if (logAutoRefreshTimer) clearInterval(logAutoRefreshTimer);
    document.getElementById('logAutoRefreshTip').style.display = 'none';
    document.getElementById('refreshLogBtn').disabled = false;
  }
  
  // Key区块每30秒自动刷新
  let keyAutoRefreshTimer = null;
  
  function startKeyAutoRefresh() {
    if (keyAutoRefreshTimer) clearInterval(keyAutoRefreshTimer);
    document.getElementById('keyAutoRefreshTip').style.display = '';
    document.getElementById('refreshKeyBtn').disabled = true;
    keyAutoRefreshTimer = setInterval(loadKeyList, 30000);
  }
  
  function stopKeyAutoRefresh() {
    if (keyAutoRefreshTimer) clearInterval(keyAutoRefreshTimer);
    document.getElementById('keyAutoRefreshTip').style.display = 'none';
    document.getElementById('refreshKeyBtn').disabled = false;
  }
  
  window.addEventListener('DOMContentLoaded', ()=>{
    // 页面加载时所有区块并行请求，并显示加载提示
    document.getElementById('logLoadingTip').style.display = '';
    document.getElementById('keyLoadingTip').style.display = '';
    
    Promise.all([
      (async()=>{loadTaskList();})(),
      (async()=>{loadSettings();})(),
      (async()=>{loadLog();})(),
      (async()=>{loadKeyList();})()
    ]);
    
    // 页面初始化时尝试显示记录链接
    const tid = document.getElementById('taskid').innerText;
    if(tid && tid !== '(无)'){
      const link = document.getElementById('recordlink');
      link.href = location.protocol + '//' + location.host + '/api/page/' + tid;
      link.innerText = '记录链接';
      document.getElementById('recordlinkbox').style.display = '';
    }
    
    // 检测设备尺寸设置合适布局
    detectScreenSize();
    
    // 监听屏幕尺寸变化
    window.addEventListener('resize', detectScreenSize);
    
    // 启动自动刷新
    startAutoRefreshTaskList();
    startLogAutoRefresh();
    startKeyAutoRefresh();
    
    // 显示管理员面板
    showAdminPanels();
  });
  </script>
</body>
</html>

